<div class="row">
	<div class="col-md-4 pull-right">
		<div class="row">
		<%= form_for(Attachment.new) do |f| %>

			<%= render 'shared/error_messages', object: f.object %>
		
			<%= f.label :file, "Image upload" %>
			<%= f.file_field :file, class: "file_upload" %>

		<%= f.submit "Upload", class: "btn btn-sm btn-default", id:"upload_image_button" %>
		<% end%>
		</div>
		<div class="row">
			<div class="btn-group">
				<div class="btn-group">
					<button type="button" class="btn btn-default dropdown-toggle" id="show_images" data-toggle="dropdown">Images <span class="caret"></span></button>
					<ul class="dropdown-menu" id="image_list">
						<li><a href='#'>Image here</a></li>
					</ul>
				</div>
				<div class="btn-group">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Activities <span class="caret"></span></button>
					<ul class="dropdown-menu" id="activity_list">
						<li><a href='#'>Activity here</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
<% content_for :jquery do %>
<script type="text/javascript">
//shamlessly stolen from stackoverflow to find current cursor position
(function ($, undefined) {
    $.fn.getCursorPosition = function () {
        var el = $(this).get(0);
        var pos = 0;
        if ('selectionStart' in el) {
            pos = el.selectionStart;
        } else if ('selection' in document) {
            el.focus();
            var Sel = document.selection.createRange();
            var SelLength = document.selection.createRange().text.length;
            Sel.moveStart('character', -el.value.length);
            pos = Sel.text.length - SelLength;
        }
        return pos;
    }
})(jQuery);

var $jq=jQuery;

function add_images_to_dropdown($image_list) {
	//clear the existing list
	$image_list.html("");
	//by default attachments path lists the most recent 20 items
	$jq.get('<%= attachments_path %>',function(json){
		//process result
		$jq.each(json, function(index, value){
			list_image($image_list, value);
		});
	});
}
function list_image($control, json){
	//add the image to the control
	$control.append(
		"<li><a href='#' id='image_"+json.id+"' class='image_item'><img src='"+json.file_url_thumb+"' />"+json.file_file_name+"</a></li>"
	);
	$jq("#image_"+json.id).click(function(event) {
		event.preventDefault();
		//insert to write up div here
		var $write_up=$jq('#write_up_input');
		var pos=$write_up.getCursorPosition();
		var content=$write_up.val();
		var new_content=content.substr(0, pos) + "\n\nimg. " + json.id + "\n\n" + content.substr(pos);
		$write_up.val(new_content);
	});
}

function add_post_click_handlers() {
	$jq("#upload_image_button").click(function(event){
		event.preventDefault();
		var $image_form=$jq("#new_attachment");
		//so... can't serialize a file input field.  bums
		var data=JSON.stringify($image_form.serializeArray());
		$jq.post($image_form[0].action,data,null,'json')
			.done(function(response) {
				if (response.id>=0) {
					//refresh the image list
					list_image($jq("#image_list"), response);
					//set the background of the image button to success
					$jq('#show_images').removeClass("btn-danger");
					$jq('#show_images').addClass("btn-success");
				} else {
					$jq('#show_images').addClass("btn-danger");
				}
			})
			.fail(function(response){
				$jq('#show_images').addClass("btn-danger");
			})
			.always(function(){
				//add a timer to reset the button colour
			})
		;
	});
}


 jQuery(add_images_to_dropdown($jq("#image_list")));
 jQuery(add_post_click_handlers());
</script>
<% end %>
	<%= form_for(@post) do |f| %>

	<div class="col-md-8">

		<%= render 'shared/error_messages', object: f.object %>

		<div class="form-group">
			<%= f.label :title %>
			<%= f.text_field :title, class: "form-control" %>
		</div>

		<div class="form-group">
			<%= f.label :category_id %>
			<%= f.collection_select :category_id, Category.all, :id, :name, {}, class: "form-control" %>
		</div>

	</div>
</div>

<div class="form-group">
	<%= f.label :write_up %>
	<%= f.text_area :write_up, rows: "20", class: "form-control form-writeup", id: "write_up_input" %>
	<p class="help-block">You can use <a href="http://redcloth.org/textile">Textile</a> formatting above to make your post pretty</p>
	<p class="help-block">The following additional tags have been added:
		<ul>
			<li>img: Use the "img" tag to add images you've uploaded.<br>Syntax: img. [&lt;|&gt;]id [Caption]<br>Where: &lt;|&gt; is the alignment indicator (left, centre, right)<br>id is the image id (see above) and caption is an optional caption.  E.g. to embed image 22 as a right aligned image use: img. >22
			</li>
			<li>map: Create a map of an activity.<br>Syntax: map. [&lt;|&gt;]id [Caption]<br>Where: &lt;|&gt; is the alignment indicator (left, centre, right)<br>id is the activity id (see above) and caption is an optional caption.  E.g. to embed a map of activity 22, centred on the page: map. |22
			</li>
		</ul>
	</p>
	<p class="help-block">
		Use the dropdown boxes at the top right of the page to select items and add the ids to the write up
	</p>
</div>

	<%= f.submit class: "btn btn-large btn-primary" %>
<% end %>