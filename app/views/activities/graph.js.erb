<%
series={}
series[:elevation]={
	input: JSON::parse(@activity.elevation_series),
	color: '#666666',
	name: "Elevation",
	unit: "metres"
} if @activity.elevation_series
series[:hr]={
	input: JSON::parse(@activity.hr_series),
	color: '#dd2222',
	name: "Heart rate",
	unit: "bpm"
} if @activity.hr_series

distance_series=JSON::parse(@activity.distance_series) if @activity.distance_series

time_series=JSON::parse(@activity.time_series).map{ |d| DateTime.parse(d).strftime("%Q").to_i }	

# Join each input up to the time_series array using zip to get our plottable array
# but only when the item itself isn't nil
series.each do |name, spec|
	if distance_series
		spec[:graph]=distance_series.zip(spec[:input]).select{|item| item[1]}
	else
		spec[:graph]=time_series.zip(spec[:input]).select{|item| item[1]}
	end
end

%>
jQuery('#graph_<%= @activity.id %>').highcharts({
	chart: {
		type: 'area'
	},
	title: {
		text: null
	},
	plotOptions: {
		series: {
			marker: {
				radius: 1
			}
		}
	},
	colors: [
		<% series.each_value.with_index do |v,i| %>
			<%= ", " if i>0 %>
			'<%= v[:color] %>'
		<% end %>
	],
	xAxis: {
		<% if distance_series %>
		type: 'linear'
		<% else %>
		type: 'datetime'
		<% end %>
	},
	yAxis: [<% series.each_value.with_index do |s,i| %><%= ", " if i>0 %>{
		title: {
			text: '<%= s[:unit] %>'
		},
		min: <%= "#{s[:input].select{|i| i}.min*0.9}" %>,
		max: <%= "#{s[:input].select{|i| i}.max*1.1}" %>
		<%= ", opposite: true" if i.odd? %>
	}<% end %>
	],
	series: [<% series.each_value.with_index do |s,i| %><%= ',' if i>0 %>{
		yAxis: <%= i %>,
		name: '<%= s[:name] %>',
		data: <%= s[:graph] %>
	}
	<%end%>
	]
});
